<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ ìƒì„¸ - ë™ë„¤ë§ˆì¼“</title>
    <link rel="stylesheet" th:href="@{/css/board_detail_market.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<!-- Header -->
<div th:replace="/header :: header"></div>

<section class="board-detail-section">
    <div class="board-detail-container">
        
        <!-- ê¸€ ì •ë³´ -->
        <div class="board-header">
            <h2 th:text="${reservation.subject}">ìƒí’ˆ ì œëª©</h2>
            <div class="board-meta">
                <span>ì‘ì„±ì: <b th:text="${reservation.author.username}">ì‘ì„±ì</b></span>
                <span>ë“±ë¡ì¼: <span th:text="${#temporals.format(reservation.createdate,'yyyy-MM-dd HH:mm')}"></span></span>
                <span th:if="${reservation.modifydate != null}">ìˆ˜ì •ì¼: <span th:text="${#temporals.format(reservation.modifydate,'yyyy-MM-dd HH:mm')}"></span></span>
            </div>
        </div>

        <!-- ê¸€ ë‚´ìš© -->
        <div class="board-content">
            <p th:text="${reservation.content}">ìƒí’ˆ ì„¤ëª…</p>
            <p>ê°€ê²©: <span th:text="${reservation.price} + 'ì›'">0ì›</span></p>
            <p>ê±°ë˜ ìœ„ì¹˜: <span th:text="${reservation.location}">ì„œìš¸</span></p>
            <div id="map" style="width:100%;height:300px;margin-top:10px;"></div>
            <!--<p>ì˜ˆì•½ ì¼ì: <span th:text="${reservation.reserveDate} + ' ' + ${reservation.reserveTime}">ë‚ ì§œ</span></p>-->
        </div>

        <!-- ê¸€ ì•¡ì…˜ -->
        <div class="board-actions">
            <!-- ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì¼ ë•Œ -->
            <th:block th:if="${#authorization.expression('isAuthenticated()')}">

                <!-- ì°œí•˜ê¸° ë²„íŠ¼ -->
                <button class="vote-btn"
                        th:onclick="'location.href=\'/reservation/vote/' + ${reservation.id} + '\';'">
                    ğŸ‘ ì¢‹ì•„ìš” (<span th:text="${#lists.size(reservation.voter)}">0</span>)
                </button>

                <!-- ê¸€ ì‘ì„±ì ë³¸ì¸ ì œì™¸: ê±°ë˜ ìš”ì²­ ë²„íŠ¼ -->
                <th:block th:if="${#authentication.principal != null and reservation.author.username != #authentication.principal.username}">
                    <button id="reserve-btn" class="request-btn" 
                            th:data-reservation-id="${reservation.id}" 
                            onclick="openModal()">
                        ğŸ“… ê±°ë˜ ìš”ì²­
                    </button>
                </th:block>

                <!-- ê¸€ ì‘ì„±ì ë³¸ì¸ë§Œ ìˆ˜ì •/ì‚­ì œ -->
                <th:block th:if="${#authentication.principal != null and reservation.author.username == #authentication.principal.username}">
                    <button class="edit-btn"
                            th:onclick="'location.href=\'/reservation/modify/' + ${reservation.id} + '\';'">
                        âœï¸ ìˆ˜ì •í•˜ê¸°
                    </button>

                    <button class="delete-btn"
                            th:onclick="'if(confirm(\'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\')) location.href=\'/reservation/delete/' + ${reservation.id} + '\';'">
                        ğŸ—‘ï¸ ì‚­ì œ
                    </button>
                </th:block>

            </th:block>

            <a th:href="@{/reservation/list}" class="list-btn">ê¸€ ëª©ë¡</a>
        </div>

        <!-- ì˜ˆì•½ ëª¨ë‹¬ -->
        <div id="modal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">ê±°ë˜ ìš”ì²­</div>
                <div class="modal-body">
                    <label for="reserve-date">ë‚ ì§œ ì„ íƒ</label>
                    <input type="date" id="reserve-date"/>
                    <label for="reserve-time">ì‹œê°„ ì„ íƒ</label>
                    <input type="time" id="reserve-time"/>
                </div>
                <div class="modal-actions">
                    <button class="cancel-btn-modal" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button class="save-btn" onclick="saveReservation()">í™•ì¸</button>
                </div>
            </div>
        </div>

       <!-- ì˜ˆì•½ ìš”ì²­ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ -->
<div class="reservation-list">
    <h3>ì˜ˆì•½ ìš”ì²­ ë‚´ì—­</h3>
    <ul>
        <li th:each="r : ${reservation.reservations}">
            <span th:text="${r.user != null ? r.user.username : 'íƒˆí‡´í•œ ì‚¬ìš©ì'}">ì‚¬ìš©ì</span> - 
            <span th:text="${r.reserveDate} + ' ' + ${r.reserveTime}">ë‚ ì§œ</span>

            <!-- ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ë³¸ì¸ì´ ì˜ˆì•½ ìš”ì²­ ì‚­ì œ ê°€ëŠ¥ -->
            <th:block th:if="${#authentication.principal != null and r.user != null and r.user.username == #authentication.principal.username}">
                <button class="delete-reservation-btn"
                        th:onclick="'if(confirm(\'ì •ë§ ì˜ˆì•½ ìš”ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\')) location.href=\'/reservation/request/delete/' + ${r.id} + '\';'">
                    âŒ ì‚­ì œ
                </button>
            </th:block>
        </li>
    </ul>
</div>

    </div>
</section>



<script>
function openModal() {
    document.getElementById('modal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('modal').style.display = 'none';
}

function saveReservation() {
    const date = document.getElementById('reserve-date').value;
    const time = document.getElementById('reserve-time').value;
    if (!date || !time) {
        alert("ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    // ì˜ˆì•½ ë²„íŠ¼ data ì†ì„±ì—ì„œ reservationId ê°€ì ¸ì˜¤ê¸°
    const reservationBtn = document.getElementById('reserve-btn');
if (!reservationBtn) {
    alert("ì˜ˆì•½í•  ìˆ˜ ì—†ëŠ” ê¸€ì…ë‹ˆë‹¤.");
    return;
}
const reservationId = reservationBtn.dataset.reservationId;

fetch('/reservation/request/' + reservationId, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reserveDate: date, reserveTime: time })
})
.then(async res => {
    if (res.ok) {
        location.reload();
    } else {
        // ì„œë²„ì—ì„œ ë³´ë‚´ì¤€ ë©”ì‹œì§€ ì½ê¸°
        const msg = await res.text();
        alert(msg || "ì˜ˆì•½ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
});
    closeModal();
}
</script>
<!-- ì¹´ì¹´ì˜¤ ì§€ë„ SDK -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8c6541871bc3305cd9e0a398a3f3115d&libraries=services"></script>
<script>
    var mapContainer = document.getElementById('map');
    var mapOption = {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // ê¸°ë³¸ ì„œìš¸ ì¤‘ì‹¬
        level: 5
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);
    var geocoder = new kakao.maps.services.Geocoder();
    var marker = new kakao.maps.Marker({ map: map });

    // reservation.location ê°’ì´ ìˆìœ¼ë©´ ìë™ ê²€ìƒ‰
    document.addEventListener("DOMContentLoaded", function() {
        var locationVal = '[[${reservation.location}]]';
        if(locationVal) {
            geocoder.addressSearch(locationVal, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                    marker.setPosition(coords);
                    map.setCenter(coords);
                }
            });
        }
    });
</script>
<!-- Footer 
<div th:replace="/footer :: footer"></div>-->
</body>
</html>
